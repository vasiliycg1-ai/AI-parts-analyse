{% extends "base.html" %}

{% block content %}


<!-- Навигация вкладками -->
<ul class="nav nav-tabs mb-4" id="orderTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="new-tab" data-bs-toggle="tab" data-bs-target="#new" type="button">
            <i class="bi bi-plus-circle"></i> Новый заказ
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="saved-tab" data-bs-toggle="tab" data-bs-target="#saved" type="button">
            <i class="bi bi-folder"></i> Сохраненные заказы
        </button>
    </li>
</ul>

<!-- Содержимое вкладок -->
<div class="tab-content" id="orderTabsContent">
    <!-- ВКЛАДКА НОВОГО ЗАКАЗА (существующий контент) -->
    <div class="tab-pane fade show active" id="new" role="tabpanel">


<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-cart-plus"></i> Подготовка заказа</h2>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Назад
    </a>
</div>

<!-- Карточка загрузки файла -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="bi bi-upload"></i> Загрузка заказа из Excel</h5>
    </div>
    <div class="card-body">
        <form id="uploadOrderForm" enctype="multipart/form-data">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Файл заказа (.xlsx, .xls)</label>
                    <input type="file" class="form-control" id="orderFile" accept=".xlsx,.xls" required>
                    <div class="form-text">
                        Колонки: Марка, Артикул, Количество
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Название заказа</label>
                    <input type="text" class="form-control" id="orderName" placeholder="Например: Заказ ноябрь 2024" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-upload"></i> Загрузить
                    </button>
                </div>
            </div>
        </form>
        <div id="uploadResult" class="mt-3" style="display: none;"></div>
    </div>
</div>

<!-- Блок расчета коэффициента -->
<div class="card mb-4" id="calculationCard" style="display: none;">
    <div class="card-header">
        <h5><i class="bi bi-calculator"></i> Расчет закупочных цен</h5>
    </div>
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Коэффициент наценки</label>
                <input type="number" step="0.001" class="form-control" id="coefficientInput" 
                       value="0.835" onchange="recalculateOrder()">
                <div class="form-text">
                    Формула: (Цена в валюта × Курс + Доставка × Вес) / Коэффициент
                </div>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-primary w-100" onclick="recalculateOrder()">
                    <i class="bi bi-arrow-clockwise"></i> Пересчитать
                </button>
            </div>
<!-- В карточке расчета, рядом с кнопкой пересчета -->
<div class="col-md-4">
    <label class="form-label">Экспорт для поставщика</label>
    <div class="input-group">
        <select class="form-select" id="supplierRegionSelect">
            <option value="китай">Китай (USD/CNY)</option>
            <option value="оаэ">ОАЭ (USD/AED)</option>
            <option value="япония">Япония (JPY)</option>
        </select>
        <button class="btn btn-outline-success" type="button" onclick="exportForSupplier()">
            <i class="bi bi-download"></i>
        </button>
    </div>
</div>
            <div class="col-md-7">
                <div class="d-flex gap-2 justify-content-end">
                    <span class="badge bg-success">Лучшая цена</span>
                    <span class="badge bg-primary">Высокая прибыль</span>
                    <span class="badge bg-warning">Нет данных</span>
                    <span class="badge bg-danger">Убыток</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Таблица заказа (изначально скрыта) -->
<div class="card" id="orderTableCard" style="display: none;">
<div class="card-header d-flex justify-content-between align-items-center">
    <h5><i class="bi bi-table"></i> Детали заказа</h5>
    <div>
        <span id="orderStats" class="badge bg-primary me-2">0 позиций</span>
        <button class="btn btn-sm btn-outline-secondary me-2" onclick="addManualRow()">
            <i class="bi bi-plus-circle"></i> Добавить строку
        </button>
        <button class="btn btn-sm btn-warning me-2" onclick="saveOrder()" id="saveOrderBtn">
            <i class="bi bi-floppy"></i> Сохранить заказ
        </button>
        <button class="btn btn-sm btn-success" onclick="exportToExcel()" id="exportBtn" style="display: none;">
            <i class="bi bi-download"></i> Экспорт в Excel  
        </button>
    </div>
</div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="orderTable">
                <thead>
                    <tr>
                        <th width="4%">#</th>
                        <th width="8%">Марка</th>
                        <th width="10%">Артикул</th>
                        <th width="18%">Название</th>
                        <th width="6%">Вес (кг)</th>
                        <th width="6%">Кол-во</th>
                        <th width="8%">Цена продажи</th>
                        
                        <!-- Регионы -->
                        <th width="10%">Китай</th>
                        <th width="10%">ОАЭ</th>
                        <th width="10%">Япония</th>
                        
                        <th width="10%">Статистика</th>
                        <th width="10%">Действия</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <!-- Данные будут заполняться через JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

    </div>

    <!-- ВКЛАДКА СОХРАНЕННЫХ ЗАКАЗОВ -->
    <div class="tab-pane fade" id="saved" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-folder"></i> Сохраненные заказы</h5>
            </div>
            <div class="card-body">
                <div id="savedOrdersList">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка списка заказов...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Модальное окно для добавления/редактирования строки -->
<div class="modal fade" id="editOrderItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalTitle">Редактирование позиции</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editOrderItemForm">
                    <input type="hidden" id="editItemIndex">
                    <input type="hidden" id="editPartId">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Марка *</label>
                            <input type="text" class="form-control" id="editBrand" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Артикул *</label>
                            <input type="text" class="form-control" id="editArticle" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Количество *</label>
                            <input type="number" class="form-control" id="editQuantity" min="1" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Вес (кг)</label>
                            <input type="number" step="0.001" class="form-control" id="editWeight">
                            <div class="form-text">Из каталога: <span id="catalogWeightText">-</span></div>
                        </div>
<div class="col-md-4">
    <label class="form-label">Цена продажи (руб)</label>
    <input type="number" step="0.01" class="form-control" id="editSalePrice">
    <div class="form-text">
        Текущая: <span id="currentPriceText">-</span>
        <br>
        Дата: <span id="currentPriceDate">-</span>
    </div>
</div>
                        <div class="col-12">
                            <label class="form-label">Название детали</label>
                            <input type="text" class="form-control" id="editName" readonly>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editUpdateCatalog">
                                <label class="form-check-label" for="editUpdateCatalog">
                                    Обновить данные в каталоге
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editUpdatePrice">
                                <label class="form-check-label" for="editUpdatePrice">
                                    Обновить цену продажи
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" onclick="deleteOrderItem()">Удалить</button>
                <button type="button" class="btn btn-primary" onclick="saveOrderItem()">Сохранить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentOrder = {
    name: '',
    items: [],
    coefficient: 0.835
};

// Загрузка файла заказа
document.getElementById('uploadOrderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('orderFile');
    const orderName = document.getElementById('orderName').value;
    const file = fileInput.files[0];
    
    if (!file || !orderName) {
        alert('Заполните все поля');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('order_name', orderName);

    // Показываем индикатор загрузки
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Загрузка...';
    submitBtn.disabled = true;

    fetch('/api/order/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;

        if (data.success) {
            currentOrder = data.order_data;
            
            // Автоматически запускаем расчет цен
            setTimeout(() => {
                recalculateOrder();
            }, 500);
            
            document.getElementById('orderTableCard').style.display = 'block';
//            document.getElementById('exportBtn').style.display = 'inline-block';
            
            document.getElementById('uploadResult').innerHTML = `
                <div class="alert alert-success">
                    <strong>✅ Заказ успешно загружен!</strong><br>
                    Обработано позиций: ${data.order_data.items.length}
                </div>
            `;
            document.getElementById('uploadResult').style.display = 'block';
        } else {
            document.getElementById('uploadResult').innerHTML = `
                <div class="alert alert-danger">
                    <strong>❌ Ошибка:</strong> ${data.error}
                </div>
            `;
            document.getElementById('uploadResult').style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        alert('Ошибка при загрузке файла');
    });
});

// Экспорт заказа для поставщика
function exportForSupplier() {
    if (currentOrder.items.length === 0) {
        alert('Нет данных для экспорта');
        return;
    }
    
    const supplierRegion = document.getElementById('supplierRegionSelect').value;
    
    // Проверяем есть ли данные по выбранному региону
    const hasRegionData = currentOrder.items.some(item => {
        const regionData = item.regions?.[supplierRegion];
        return regionData && regionData.price_original !== null;
    });
    
    if (!hasRegionData) {
        alert(`Нет данных по ценам для региона ${supplierRegion}`);
        return;
    }
    
    // Показываем индикатор загрузки
    const exportBtn = document.querySelector('[onclick="exportForSupplier()"]');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    exportBtn.disabled = true;

    fetch('/api/order/export_supplier_detailed', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_data: currentOrder,
            supplier_region: supplierRegion
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Ошибка экспорта');
            });
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `заказ_${supplierRegion}_${new Date().toISOString().slice(0,10)}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
        alert('Ошибка при экспорте: ' + error.message);
    });
}


// Загрузка списка сохраненных заказов
function loadSavedOrders() {
    fetch('/api/orders/list')
        .then(response => response.json())
        .then(data => {
            const ordersList = document.getElementById('savedOrdersList');
            
            if (data.success && data.orders.length > 0) {
                ordersList.innerHTML = data.orders.map(order => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="card-title">${order.order_name}</h6>
                                    <p class="card-text small text-muted mb-1">
                                        Дата: ${order.order_date} | 
                                        Позиций: ${order.items_count} | 
                                        Коэффициент: ${order.coefficient}
                                    </p>
                                    <small class="text-muted">
                                        Создан: ${new Date(order.created_at).toLocaleDateString()}
                                    </small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-sm btn-outline-primary me-2" 
                                            onclick="loadOrder(${order.id})">
                                        <i class="bi bi-folder2-open"></i> Открыть
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteOrder(${order.id}, '${order.order_name}')">
                                        <i class="bi bi-trash"></i> Удалить
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                ordersList.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-folder-x display-4 text-muted"></i>
                        <p class="mt-3 text-muted">Нет сохраненных заказов</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('savedOrdersList').innerHTML = `
                <div class="alert alert-danger">
                    Ошибка при загрузке списка заказов
                </div>
            `;
        });
}

// Загрузка конкретного заказа
function loadOrder(orderId) {
    console.log('Начало загрузки заказа:', orderId);
    
    fetch(`/api/order/load/${orderId}`)
        .then(response => response.json())
        .then(data => {
            console.log('Ответ от API:', data);
            
            if (data.success) {
                currentOrder = data.order_data;
                console.log('Загружено позиций:', currentOrder.items.length);
                
                // ПОКАЗЫВАЕМ ОСНОВНЫЕ БЛОКИ КАК ПРИ ЗАГРУЗКЕ ИЗ ФАЙЛА
                document.getElementById('orderTableCard').style.display = 'block';
                document.getElementById('calculationCard').style.display = 'block';
                document.getElementById('exportBtn').style.display = 'inline-block';
                document.getElementById('saveOrderBtn').style.display = 'inline-block';
                
                // Устанавливаем коэффициент
                document.getElementById('coefficientInput').value = currentOrder.coefficient;
                
                // Сначала отображаем базовые данные
                displayOrderItems();
                
                // ЗАПУСКАЕМ РАСЧЕТ ЦЕН ПО РЕГИОНАМ!
                console.log('Запуск расчета цен...');
                setTimeout(() => {
                    recalculateOrder();
                }, 500);
                
                // Переключаемся на вкладку нового заказа
                const newTab = new bootstrap.Tab(document.getElementById('new-tab'));
                newTab.show();
                
                // Показываем уведомление
                alert('Заказ успешно загружен! Расчет цен запущен...');
            } else {
                console.error('Ошибка загрузки:', data.error);
                alert('Ошибка загрузки: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка сети:', error);
            alert('Ошибка при загрузке заказа');
        });
}


// Удаление заказа
function deleteOrder(orderId, orderName) {
    if (confirm(`Удалить заказ "${orderName}"?`)) {
        fetch(`/api/order/delete/${orderId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadSavedOrders(); // Обновляем список
                alert('Заказ удален');
            } else {
                alert('Ошибка удаления: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при удалении заказа');
        });
    }
}

// Загружаем сохраненные заказы при переходе на вкладку
document.addEventListener('DOMContentLoaded', function() {
    const savedTab = document.getElementById('saved-tab');
    savedTab.addEventListener('shown.bs.tab', function() {
        loadSavedOrders();
    });
});



// Функция пересчета заказа
function recalculateOrder() {
    const coefficient = parseFloat(document.getElementById('coefficientInput').value);
    currentOrder.coefficient = coefficient;
    
    // Показываем индикатор загрузки
    const recalcBtn = event?.target || document.querySelector('[onclick="recalculateOrder()"]');
    const originalText = recalcBtn.innerHTML;
    recalcBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Расчет...';
    recalcBtn.disabled = true;

    fetch('/api/order/calculate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            items: currentOrder.items,
            coefficient: coefficient
        })
    })
    .then(response => response.json())
    .then(data => {
        recalcBtn.innerHTML = originalText;
        recalcBtn.disabled = false;

        if (data.success) {
            currentOrder.items = data.order_data.items;
            currentOrder.coefficient = data.order_data.coefficient;
            displayOrderItems();
        } else {
            alert('Ошибка расчета: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        recalcBtn.innerHTML = originalText;
        recalcBtn.disabled = false;
        alert('Ошибка при расчете цен');
    });
}

// Экспорт заказа в Excel
function exportToExcel() {
    if (currentOrder.items.length === 0) {
        alert('Нет данных для экспорта');
        return;
    }
    
    // Показываем индикатор загрузки
    const exportBtn = document.getElementById('exportBtn');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Экспорт...';
    exportBtn.disabled = true;

    fetch('/api/order/export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_data: currentOrder
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Ошибка экспорта');
        }
        return response.blob();
    })
    .then(blob => {
        // Создаем ссылку для скачивания
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `заказ_${new Date().toISOString().slice(0,10)}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Восстанавливаем кнопку
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
        alert('Ошибка при экспорте в Excel');
    });
}

// Отображение элементов заказа
function displayOrderItems() {
    const tbody = document.getElementById('orderTableBody');
    const statsBadge = document.getElementById('orderStats');
    
    if (currentOrder.items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="12" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Загрузка данных...
                </td>
            </tr>
        `;
        statsBadge.textContent = 'Загрузка...';
        return;
    }
    
    statsBadge.textContent = `${currentOrder.items.length} позиций`;
    
    // АВТОМАТИЧЕСКИ ПОКАЗЫВАЕМ БЛОКИ ЕСЛИ ЕСТЬ ДАННЫЕ
    if (currentOrder.items.length > 0) {
        document.getElementById('orderTableCard').style.display = 'block';
        document.getElementById('calculationCard').style.display = 'block';
        document.getElementById('exportBtn').style.display = 'inline-block';
        document.getElementById('saveOrderBtn').style.display = 'inline-block';
        
        // Устанавливаем коэффициент если он есть в заказе
        if (currentOrder.coefficient) {
            document.getElementById('coefficientInput').value = currentOrder.coefficient;
        }
    }
    
    // Остальной код отображения таблицы...
    tbody.innerHTML = currentOrder.items.map((item, index) => {
        const weightClass = getWeightClass(item);
        const priceClass = getPriceClass(item);
        const priceDateClass = getPriceDateClass(item.sale_price_date);
        // Объединяем классы для цены продажи
        const combinedPriceClass = [priceClass, priceDateClass].filter(Boolean).join(' ');
                
        return `
            <tr>
                <td>${index + 1}</td>
                <td>${item.brand}</td>
                <td>${item.article}</td>
                <td>${item.name || '-'}</td>
                <td class="${weightClass}">
                    ${item.catalog_weight ? item.catalog_weight.toFixed(3) : 'Нет данных'}
                </td>
                <td>${item.quantity}</td>
                <td class="${combinedPriceClass}" title="${getPriceDateTooltip(item.sale_price_date)}">
                    ${renderSalePrice(item)}
                </td>
                ${renderRegionCells(item)}
                <td>${item.statistics || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editOrderItem(${index})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeOrderItem(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}


// Функция для отображения цены с датой
function renderSalePrice(item) {
    if (!item.sale_price) {
        return 'Нет данных';
    }
    
    const priceText = item.sale_price.toFixed(2) + ' руб.';
    
    if (item.sale_price_date) {
        const date = new Date(item.sale_price_date);
        const dateStr = date.toLocaleDateString('ru-RU');
        return `
            <div>
                <strong>${priceText}</strong>
                <br>
                <small class="text-muted">${dateStr}</small>
            </div>
        `;
    }
    
    return priceText;
}


// Функция для подсказки по дате
function getPriceDateTooltip(salePriceDate) {
    if (!salePriceDate) return 'Дата цены не указана';
    
    const priceDate = new Date(salePriceDate);
    const now = new Date();
    const diffTime = Math.abs(now - priceDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays > 30) {
        return `Цена установлена ${diffDays} дней назад (старше месяца)`;
    } else if (diffDays > 14) {
        return `Цена установлена ${diffDays} дней назад (старше 2 недель)`;
    }
    
    return `Цена установлена ${diffDays} дней назад (актуальная)`;
}

function getPriceDateClass(salePriceDate) {
    if (!salePriceDate) return '';
    
    const priceDate = new Date(salePriceDate);
    const now = new Date();
    const diffTime = Math.abs(now - priceDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays > 30) {
        return 'table-danger'; // Старше месяца - красный
    } else if (diffDays > 14) {
        return 'table-info'; // Старше 2 недель - голубой
    }
    return ''; // Актуальная - без подсветки
}

// Функции для определения классов подсветки
function getWeightClass(item) {
//    const displayWeight = item.custom_weight !== undefined ? item.custom_weight : item.catalog_weight;
    if (!item.catalog_weight) return 'table-warning';
    return '';
}

function getPriceClass(item) {
//    const displayPrice = item.custom_sale_price !== undefined ? item.custom_sale_price : item.sale_price;
    if (!item.sale_price) return 'table-warning';
    return '';
}

// Отрисовка ячеек регионов
function renderRegionCells(item) {
    const regions = ['китай', 'оаэ', 'япония'];
    let html = '';
    
    regions.forEach(region => {
        const regionData = item.regions?.[region];
        console.log(`Регион ${region}:`, regionData); // ОТЛАДКА
        html += renderSingleRegion(regionData, item.sale_price);
    });
    
    return html;
}

function renderSingleRegion(regionData, salePrice, regionName) {
    if (!regionData || regionData.price_rub === null) {
        return `<td class="table-warning" title="${regionName}: Нет данных">Нет данных</td>`;
    }
    
    let cellClass = '';
    let icon = '';
    let tooltip = `title="${regionName}`;
    const profit = regionData.profit_percent;
    
    // Цвет по прибыли
    if (profit < 0) {
        cellClass = 'table-danger';
        icon = '<i class="bi bi-arrow-down-circle text-danger"></i>';
        tooltip += ' - УБЫТОК';
    } else if (profit > 20) {
        cellClass = 'table-success';
        icon = '<i class="bi bi-arrow-up-circle text-success"></i>';
        tooltip += ' - Очень высокая прибыль';
    } else if (profit > 10) {
        cellClass = 'table-primary';
        icon = '<i class="bi bi-arrow-up-circle text-primary"></i>';
        tooltip += ' - Хорошая прибыль';
    } else if (profit > 0) {
        cellClass = 'table-info';
        icon = '<i class="bi bi-dash-circle text-info"></i>';
        tooltip += ' - Низкая прибыль';
    } else {
        cellClass = '';
        icon = '<i class="bi bi-dash-circle text-secondary"></i>';
        tooltip += ' - Безубыточно';
    }
    
    // Добавляем звезду для лучшей цены
    if (regionData.is_best_price) {
        icon = '<i class="bi bi-star-fill text-warning"></i> ' + icon;
        tooltip += ' (Лучшая цена)';
    }
    
    tooltip += `"`;
    
    const priceText = regionData.price_rub.toFixed(2);
    const profitText = profit !== null ? `${profit}%` : '—';
    
    return `
        <td class="${cellClass}" ${tooltip}>
            <div class="small">
                <div class="d-flex justify-content-between align-items-center">
                    <span>${icon}</span>
                    <strong>${priceText} руб.</strong>
                </div>
                <small>${profitText}</small>
            </div>
        </td>
    `;
}

// Добавление строки вручную
function addManualRow() {
    document.getElementById('editModalTitle').textContent = 'Добавление позиции';
    document.getElementById('editItemIndex').value = '';
    document.getElementById('editBrand').value = '';
    document.getElementById('editArticle').value = '';
    document.getElementById('editQuantity').value = '1';
    
    new bootstrap.Modal(document.getElementById('editOrderItemModal')).show();
}

// Редактирование строки
function editOrderItem(index) {
    const item = currentOrder.items[index];
    document.getElementById('editModalTitle').textContent = 'Редактирование позиции';
    document.getElementById('editItemIndex').value = index;
    document.getElementById('editBrand').value = item.brand;
    document.getElementById('editArticle').value = item.article;
    document.getElementById('editQuantity').value = item.quantity;
    
    new bootstrap.Modal(document.getElementById('editOrderItemModal')).show();
}

// Сохранение позиции
// Сохранение позиции с обновлением данных
function saveOrderItem() {
    const index = document.getElementById('editItemIndex').value;
    const brand = document.getElementById('editBrand').value;
    const article = document.getElementById('editArticle').value;
    const quantity = parseInt(document.getElementById('editQuantity').value);
    const weight = document.getElementById('editWeight').value ? 
        parseFloat(document.getElementById('editWeight').value) : null;
    const salePrice = document.getElementById('editSalePrice').value ? 
        parseFloat(document.getElementById('editSalePrice').value) : null;
    const updateCatalog = document.getElementById('editUpdateCatalog').checked;
    const updatePrice = document.getElementById('editUpdatePrice').checked;
    const partId = document.getElementById('editPartId').value;
    
    if (!brand || !article || !quantity) {
        alert('Заполните обязательные поля (Марка, Артикул, Количество)');
        return;
    }
    
    // Показываем индикатор загрузки
    const saveBtn = document.querySelector('[onclick="saveOrderItem()"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Сохранение...';
    saveBtn.disabled = true;

    // Сначала обновляем данные в каталоге если нужно
    const updatePromises = [];
    
    if ((updateCatalog && weight !== null) || (updatePrice && salePrice !== null)) {
        updatePromises.push(
            fetch('/api/order/update_item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    brand: brand,
                    article: article,
                    weight: weight,
                    sale_price: salePrice,
                    update_catalog: updateCatalog,
                    update_price: updatePrice
                })
            })
        );
    }
    
    // Ждем завершения всех обновлений
    Promise.all(updatePromises)
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(results => {
            // Проверяем результаты обновления
            let updateMessage = '';
            let actualPartId = partId;
            
            for (const result of results) {
                if (result.success) {
                    updateMessage = result.message;
                    if (result.part_id) {
                        actualPartId = result.part_id;
                    }
                } else {
                    console.warn('Ошибка обновления:', result.error);
                }
            }
            
            // Теперь обновляем данные в текущем заказе
            const itemData = {
                brand: brand,
                article: article,
                quantity: quantity,
                part_id: actualPartId,
                custom_weight: weight,
                custom_sale_price: salePrice,
                name: document.getElementById('editName').value || null,
                // Обновляем основные поля если данные были сохранены в каталог
                catalog_weight: updateCatalog ? weight : (currentOrder.items[index]?.catalog_weight || null),
                sale_price: updatePrice ? salePrice : (currentOrder.items[index]?.sale_price || null)
            };
            
            if (index === '') {
                // Новая строка
                currentOrder.items.push(itemData);
            } else {
                // Редактирование существующей
                currentOrder.items[index] = itemData;
            }
            
            displayOrderItems();
            
            // Пересчитываем цены после сохранения
            setTimeout(() => {
                recalculateOrder();
            }, 100);
            
            bootstrap.Modal.getInstance(document.getElementById('editOrderItemModal')).hide();
            
            // Показываем сообщение об успешном обновлении
            if (updateMessage) {
                setTimeout(() => {
                    alert(updateMessage);
                }, 300);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при сохранении данных');
        })
        .finally(() => {
            // Восстанавливаем кнопку
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
}


// Поиск детали при изменении бренда или артикула
function findPart() {
    const brand = document.getElementById('editBrand').value;
    const article = document.getElementById('editArticle').value;

    if (!brand || !article) {
        return;
    }
    
    fetch('/api/order/find_part', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            brand: brand,
            article: article
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.found) {
            const part = data.part_data;

    const priceDate = part.sale_price_date ? 
        new Date(part.sale_price_date).toLocaleDateString('ru-RU') : 'Нет данных';
    document.getElementById('currentPriceDate').textContent = priceDate;

            document.getElementById('editPartId').value = part.id;
            document.getElementById('editName').value = part.name || '-';
            document.getElementById('catalogWeightText').textContent = 
                part.weight ? part.weight.toFixed(3) + ' кг' : 'Нет данных';
            document.getElementById('currentPriceText').textContent = 
                part.sale_price ? part.sale_price.toFixed(2) + ' руб.' : 'Нет данных';
            
            // Заполняем поля если они пустые
            if (!document.getElementById('editWeight').value && part.weight) {
                document.getElementById('editWeight').value = part.weight;
            }
            if (!document.getElementById('editSalePrice').value && part.sale_price) {
                document.getElementById('editSalePrice').value = part.sale_price;
            }
        } else {
            document.getElementById('editPartId').value = '';
            document.getElementById('editName').value = 'Деталь не найдена в каталоге';
            document.getElementById('catalogWeightText').textContent = '-';
            document.getElementById('currentPriceText').textContent = '-';
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Обновленные функции редактирования
function addManualRow() {
    document.getElementById('editModalTitle').textContent = 'Добавление позиции';
    document.getElementById('editItemIndex').value = '';
    document.getElementById('editPartId').value = '';
    document.getElementById('editBrand').value = '';
    document.getElementById('editArticle').value = '';
    document.getElementById('editQuantity').value = '1';
    document.getElementById('editWeight').value = '';
    document.getElementById('editSalePrice').value = '';
    document.getElementById('editName').value = '';
    document.getElementById('catalogWeightText').textContent = '-';
    document.getElementById('currentPriceText').textContent = '-';
    document.getElementById('editUpdateCatalog').checked = false;
    document.getElementById('editUpdatePrice').checked = false;
    
    // Убираем кнопку удаления для новой строки
    document.querySelector('[onclick="deleteOrderItem()"]').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('editOrderItemModal')).show();
}

function editOrderItem(index) {
    const item = currentOrder.items[index];
    const priceDate = item.sale_price_date ? 
        new Date(item.sale_price_date).toLocaleDateString('ru-RU') : 'Нет данных';
    document.getElementById('currentPriceDate').textContent = priceDate;
    document.getElementById('editModalTitle').textContent = 'Редактирование позиции';
    document.getElementById('editItemIndex').value = index;
    document.getElementById('editPartId').value = item.part_id || '';
    document.getElementById('editBrand').value = item.brand;
    document.getElementById('editArticle').value = item.article;
    document.getElementById('editQuantity').value = item.quantity;
    document.getElementById('editWeight').value = item.custom_weight || item.catalog_weight || '';
    document.getElementById('editSalePrice').value = item.custom_sale_price || item.sale_price || '';
    document.getElementById('editName').value = item.name || '-';
    document.getElementById('catalogWeightText').textContent = 
        item.catalog_weight ? item.catalog_weight.toFixed(3) + ' кг' : 'Нет данных';
    document.getElementById('currentPriceText').textContent = 
        item.sale_price ? item.sale_price.toFixed(2) + ' руб.' : 'Нет данных';
    document.getElementById('editUpdateCatalog').checked = true;
    document.getElementById('editUpdatePrice').checked = false;
    
    // Показываем кнопку удаления для существующей строки
    document.querySelector('[onclick="deleteOrderItem()"]').style.display = 'inline-block';
    
    new bootstrap.Modal(document.getElementById('editOrderItemModal')).show();
}

function saveItemToOrder(index, itemData) {
    if (index === '') {
        // Новая строка
        currentOrder.items.push(itemData);
    } else {
        // Редактирование существующей
        currentOrder.items[index] = itemData;
    }
    
    displayOrderItems();
    
    // Пересчитываем цены после сохранения
    setTimeout(() => {
        recalculateOrder();
    }, 100);
    
    bootstrap.Modal.getInstance(document.getElementById('editOrderItemModal')).hide();
}

// Удаление позиции из модального окна
function deleteOrderItem() {
    const index = document.getElementById('editItemIndex').value;
    if (index !== '' && confirm('Удалить эту позицию из заказа?')) {
        currentOrder.items.splice(index, 1);
        displayOrderItems();
        bootstrap.Modal.getInstance(document.getElementById('editOrderItemModal')).hide();
    }
}

// Сохранение всего заказа
function saveOrder() {
    if (!currentOrder.name || currentOrder.items.length === 0) {
        alert('Нет данных для сохранения');
        return;
    }
    
    fetch('/api/order/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_name: currentOrder.name,
            items: currentOrder.items,
            coefficient: currentOrder.coefficient
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        } else {
            alert('Ошибка сохранения: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при сохранении заказа');
    });
}

// Добавим слушатели событий для поиска детали
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('editBrand').addEventListener('blur', findPart);
    document.getElementById('editArticle').addEventListener('blur', findPart);
});


// Удаление позиции
function removeOrderItem(index) {
    if (confirm('Удалить эту позицию из заказа?')) {
        currentOrder.items.splice(index, 1);
        displayOrderItems();
    }
}
</script>

<style>
.table-warning {
    background-color: #fff3cd !important;
}
.table-success {
    background-color: #d1e7dd !important;
}
.table-primary {
    background-color: #cfe2ff !important;
}
.table-danger {
    background-color: #f8d7da !important;
}
</style>
{% endblock %}