{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-truck"></i> Стоимость доставки по регионам</h2>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Назад
    </a>
</div>

<div class="row">
    <div class="col-lg-5">
        <div class="card">
            <div class="card-header">
                <h5>Добавить стоимость доставки</h5>
            </div>
            <div class="card-body">
                <form id="addDeliveryCostForm">
                    <div class="mb-3">
                        <label class="form-label">Регион *</label>
                        <select class="form-select" id="deliveryRegion" required>
                            <option value="">-- Выберите регион --</option>
                            {% for region in regions %}
                            <option value="{{ region.id }}">{{ region.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Стоимость за 1 кг (руб) *</label>
                        <input type="number" step="0.01" class="form-control" id="costPerKg" required>
                        <div class="form-text">Стоимость доставки за 1 килограмм веса</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Минимальная стоимость (руб) *</label>
                        <input type="number" step="0.01" class="form-control" id="minCost" required>
                        <div class="form-text">Минимальная стоимость доставки независимо от веса</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Примечание</label>
                        <input type="text" class="form-control" id="deliveryDescription" 
                               placeholder="Например: Авиадоставка, наземная доставка и т.д.">
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-plus-circle"></i> Добавить
                    </button>
                </form>
            </div>
        </div>

        <!-- Блок информации -->
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="bi bi-info-circle"></i> Как рассчитывается доставка</h6>
            </div>
            <div class="card-body">
                <p class="small mb-2">
                    <strong>Формула расчета:</strong><br>
                    Стоимость = MAX(Минимальная стоимость, Вес × Стоимость за 1 кг)
                </p>
                <p class="small mb-0 text-muted">
                    <strong>Пример:</strong><br>
                    Вес: 3 кг, Стоимость за кг: 150 руб, Минимум: 500 руб<br>
                    Расчет: MAX(500, 3 × 150) = MAX(500, 450) = <strong>500 руб</strong>
                </p>
            </div>
        </div>
    </div>

    <div class="col-lg-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Текущие тарифы доставки</h5>
                <span class="badge bg-primary">{{ delivery_costs|length }} регионов</span>
            </div>
            <div class="card-body">
                {% if delivery_costs %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Регион</th>
                                <th>За 1 кг</th>
                                <th>Минимум</th>
                                <th>Пример для 5 кг</th>
                                <th>Примечание</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cost in delivery_costs %}
                            <tr>
                                <td>
                                    <strong>{{ cost.region_name }}</strong>
                                </td>
                                <td>
                                    <span class="fw-bold text-primary">{{ "%.2f"|format(cost.cost_per_kg) }} руб.</span>
                                </td>
                                <td>
                                    <span class="fw-bold text-info">{{ "%.2f"|format(cost.min_cost) }} руб.</span>
                                </td>
                                <td>
                                    {% set example_cost = [cost.min_cost, 5 * cost.cost_per_kg] | max %}
                                    <span class="badge bg-{{ 'success' if example_cost == cost.min_cost else 'warning' }}">
                                        {{ "%.2f"|format(example_cost) }} руб.
                                    </span>
                                    <small class="text-muted d-block">
                                        {% if example_cost == cost.min_cost %}
                                        по минимуму
                                        {% else %}
                                        по весу
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    {{ cost.description or '-' }}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="editDeliveryCost({{ cost.id }}, '{{ cost.region_name }}', {{ cost.cost_per_kg }}, {{ cost.min_cost }}, '{{ cost.description or '' }}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-truck display-1 text-muted"></i>
                    <p class="text-muted mt-3">Нет настроенных тарифов доставки</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования -->
<div class="modal fade" id="editDeliveryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактирование стоимости доставки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editDeliveryForm">
                    <input type="hidden" id="editDeliveryId">
                    <div class="mb-3">
                        <label class="form-label">Регион</label>
                        <input type="text" class="form-control" id="editRegionDisplay" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Стоимость за 1 кг (руб) *</label>
                        <input type="number" step="0.01" class="form-control" id="editCostPerKg" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Минимальная стоимость (руб) *</label>
                        <input type="number" step="0.01" class="form-control" id="editMinCost" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Примечание</label>
                        <input type="text" class="form-control" id="editDeliveryDescription">
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <i class="bi bi-calculator"></i>
                            <strong>Пример расчета:</strong><br>
                            При весе 5 кг: <span id="calculationExample">-</span> руб.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveDeliveryCost()">Сохранить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Добавление стоимости доставки
document.getElementById('addDeliveryCostForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const deliveryData = {
        region_id: document.getElementById('deliveryRegion').value,
        cost_per_kg: parseFloat(document.getElementById('costPerKg').value),
        min_cost: parseFloat(document.getElementById('minCost').value),
        description: document.getElementById('deliveryDescription').value
    };

    if (!deliveryData.region_id) {
        alert('Выберите регион');
        return;
    }

    fetch('/api/delivery_costs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(deliveryData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Стоимость доставки успешно добавлена!');
            document.getElementById('addDeliveryCostForm').reset();
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при добавлении стоимости доставки');
    });
});

// Редактирование стоимости доставки
function editDeliveryCost(id, regionName, costPerKg, minCost, description) {
    document.getElementById('editDeliveryId').value = id;
    document.getElementById('editRegionDisplay').value = regionName;
    document.getElementById('editCostPerKg').value = costPerKg;
    document.getElementById('editMinCost').value = minCost;
    document.getElementById('editDeliveryDescription').value = description || '';
    
    updateCalculationExample();
    new bootstrap.Modal(document.getElementById('editDeliveryModal')).show();
}

// Сохранение стоимости доставки
function saveDeliveryCost() {
    const deliveryData = {
        id: document.getElementById('editDeliveryId').value,
        cost_per_kg: parseFloat(document.getElementById('editCostPerKg').value),
        min_cost: parseFloat(document.getElementById('editMinCost').value),
        description: document.getElementById('editDeliveryDescription').value
    };

    fetch('/api/delivery_costs', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(deliveryData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Стоимость доставки успешно обновлена!');
            bootstrap.Modal.getInstance(document.getElementById('editDeliveryModal')).hide();
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при сохранении стоимости доставки');
    });
}

// Обновление примера расчета
function updateCalculationExample() {
    const costPerKg = parseFloat(document.getElementById('editCostPerKg').value) || 0;
    const minCost = parseFloat(document.getElementById('editMinCost').value) || 0;
    const exampleWeight = 5; // 5 кг для примера
    
    const calculatedCost = exampleWeight * costPerKg;
    const finalCost = Math.max(minCost, calculatedCost);
    
    const exampleElement = document.getElementById('calculationExample');
    exampleElement.innerHTML = `
        <strong>${finalCost.toFixed(2)}</strong> 
        <small class="text-muted">
            (MAX(${minCost.toFixed(2)}, ${exampleWeight} × ${costPerKg.toFixed(2)}))
        </small>
    `;
}

// Слушаем изменения в полях для обновления примера
document.getElementById('editCostPerKg')?.addEventListener('input', updateCalculationExample);
document.getElementById('editMinCost')?.addEventListener('input', updateCalculationExample);
</script>

<style>
.table td {
    vertical-align: middle;
}
.badge.bg-success {
    background-color: #198754 !important;
}
.badge.bg-warning {
    background-color: #ffc107 !important;
    color: #000 !important;
}
</style>
{% endblock %}