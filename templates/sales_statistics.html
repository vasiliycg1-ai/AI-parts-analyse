{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-graph-up-arrow"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h2>
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
    </a>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∞–º–∏ -->
<ul class="nav nav-tabs mb-4" id="statsTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="view-tab" data-bs-toggle="tab" data-bs-target="#view" type="button">
            <i class="bi bi-table"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button">
            <i class="bi bi-upload"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        </button>
    </li>
</ul>

<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
<div class="tab-content" id="statsTabsContent">
    <!-- –í–ö–õ–ê–î–ö–ê –ü–†–û–°–ú–û–¢–†–ê -->
    <div class="tab-pane fade show active" id="view" role="tabpanel">
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö</label>
                        <select class="form-select" id="dataTypeFilter" onchange="loadStatistics()">
                            <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
                            <option value="own_sales">–ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏</option>
                            <option value="competitor_sales">–ü—Ä–æ–¥–∞–∂–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</option>
                            <option value="analytics_center">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">–ì—Ä—É–ø–ø–∞ —Å–ø—Ä–æ—Å–∞</label>
                        <select class="form-select" id="volumeGroupFilter" onchange="loadStatistics()">
                            <option value="all">–í—Å–µ –≥—Ä—É–ø–ø—ã</option>
                            <option value="top_sales">–¢–æ–ø –ø—Ä–æ–¥–∞–∂</option>
                            <option value="good_demand">–•–æ—Ä–æ—à–∏–π —Å–ø—Ä–æ—Å</option>
                            <option value="low_demand">–ù–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å</option>
                            <option value="no_demand">–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø—Ä–æ—Å–∞</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É</label>
                        <input type="text" class="form-control" id="searchFilter" placeholder="–ê—Ä—Ç–∏–∫—É–ª –∏–ª–∏ –º–∞—Ä–∫–∞..." oninput="loadStatistics()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> –°–±—Ä–æ—Å
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-table"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h5>
                <span id="statsCount" class="badge bg-primary">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö</th>
                                <th>–ú–∞—Ä–∫–∞</th>
                                <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–ü–µ—Ä–∏–æ–¥</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th>–ì—Ä—É–ø–ø–∞</th>
                                <th>–ó–∞–ø—Ä–æ—Å—ã</th>
                                <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="statsTableBody">
                            <tr>
                                <td colspan="10" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- üëá –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö –î–õ–Ø –ü–ê–ì–ò–ù–ê–¶–ò–ò -->
                <nav id="paginationContainer" class="mt-4 d-flex justify-content-center"></nav>

            </div>
        </div>
    </div>

    <!-- –í–ö–õ–ê–î–ö–ê –ó–ê–ì–†–£–ó–ö–ò -->
    <div class="tab-pane fade" id="upload" role="tabpanel">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <!-- –§–æ—Ä–º—ã –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-upload"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="uploadTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ownSalesTab" type="button">
                                    –ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#competitorTab" type="button">
                                    –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#analyticsTab" type="button">
                                    –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-3">
                            <!-- –ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏ -->
                            <div class="tab-pane fade show active" id="ownSalesTab">
<form class="upload-form" data-type="own_sales">
    <div class="mb-3">
        <label class="form-label">–§–∞–π–ª —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏</label>
        <input type="file" class="form-control file-input" accept=".xlsx,.xls" required>
        <div class="form-text">–ö–æ–ª–æ–Ω–∫–∏: –ê—Ä—Ç–∏–∫—É–ª, –ú–∞—Ä–∫–∞, –ü–µ—Ä–∏–æ–¥, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</div>
    </div>
    <div class="row g-2">
        <div class="col-6">
            <button type="button" class="btn btn-outline-primary w-100 validate-btn">
                <i class="bi bi-search"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª
            </button>
        </div>
        <div class="col-6">
            <button type="submit" class="btn btn-success w-100 upload-btn">
                <i class="bi bi-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–∏ –ø—Ä–æ–¥–∞–∂–∏
            </button>
        </div>
    </div>
</form>
</div>
                            
                            <!-- –ü—Ä–æ–¥–∞–∂–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ -->
                            <div class="tab-pane fade" id="competitorTab">
<form class="upload-form" data-type="competitor_sales">
    <div class="mb-3">
        <label class="form-label">–§–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</label>
        <input type="file" class="form-control file-input" accept=".xlsx,.xls" required>
        <div class="form-text">–ö–æ–ª–æ–Ω–∫–∏: –ê—Ä—Ç–∏–∫—É–ª, –ú–∞—Ä–∫–∞, –ü–µ—Ä–∏–æ–¥, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ò—Å—Ç–æ—á–Ω–∏–∫</div>
    </div>
    <div class="row g-2">
        <div class="col-6">
            <button type="button" class="btn btn-outline-primary w-100 validate-btn">
                <i class="bi bi-search"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª
            </button>
        </div>
        <div class="col-6">
            <button type="submit" class="btn btn-warning w-100 upload-btn">
                <i class="bi bi-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
            </button>
        </div>
    </div>
</form>                            
</div>
                            
                            <!-- –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä -->
                            <div class="tab-pane fade" id="analyticsTab">
<form class="upload-form" data-type="analytics_center">
    <div class="mb-3">
        <label class="form-label">–§–∞–π–ª –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</label>
        <input type="file" class="form-control file-input" accept=".xlsx,.xls" required>
        <div class="form-text">–ö–æ–ª–æ–Ω–∫–∏: –ê—Ä—Ç–∏–∫—É–ª, –ú–∞—Ä–∫–∞, –ü–µ—Ä–∏–æ–¥, –ì—Ä—É–ø–ø–∞, –ó–∞–ø—Ä–æ—Å—ã</div>
    </div>
    <div class="row g-2">
        <div class="col-6">
            <button type="button" class="btn btn-outline-primary w-100 validate-btn">
                <i class="bi bi-search"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª
            </button>
        </div>
        <div class="col-6">
            <button type="submit" class="btn btn-info w-100 upload-btn">
                <i class="bi bi-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É
            </button>
        </div>
    </div>
</form>
                            </div>
                        </div>
                        
                        <div id="uploadResult" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–æ—Ä–º–∞—Ç–∞—Ö -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6><i class="bi bi-info-circle"></i> –§–æ—Ä–º–∞—Ç—ã —Ñ–∞–π–ª–æ–≤</h6>
                    </div>
                    <div class="card-body">
                        <p class="small mb-2">
                            <strong>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö:</strong><br>
                            ‚Ä¢ –ê—Ä—Ç–∏–∫—É–ª<br>
                            ‚Ä¢ –ú–∞—Ä–∫–∞<br>
                            ‚Ä¢ –ü–µ—Ä–∏–æ–¥ (–ì–ì–ì–ì-–ú–ú-–î–î)
                        </p>
                        <p class="small mb-0 text-muted">
                            <strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</strong><br>
                            ‚Ä¢ <strong>–ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏:</strong> –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ<br>
                            ‚Ä¢ <strong>–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã:</strong> –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ò—Å—Ç–æ—á–Ω–∏–∫<br>
                            ‚Ä¢ <strong>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞:</strong> –ì—Ä—É–ø–ø–∞, –ó–∞–ø—Ä–æ—Å—ã
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="editStatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editStatForm">
                    <input type="hidden" id="editStatId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö *</label>
                            <select class="form-select" id="editDataType" required>
                                <option value="own_sales">–ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏</option>
                                <option value="competitor_sales">–ü—Ä–æ–¥–∞–∂–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</option>
                                <option value="analytics_center">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ü–µ—Ä–∏–æ–¥ *</label>
                            <input type="date" class="form-control" id="editPeriod" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ú–∞—Ä–∫–∞ *</label>
                            <input type="text" class="form-control" id="editBrand" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ê—Ä—Ç–∏–∫—É–ª *</label>
                            <input type="text" class="form-control" id="editArticle" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                            <input type="number" class="form-control" id="editQuantity">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–ì—Ä—É–ø–ø–∞ —Å–ø—Ä–æ—Å–∞</label>
                            <select class="form-select" id="editVolumeGroup">
                                <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–∞</option>
                                <option value="top_sales">–¢–æ–ø –ø—Ä–æ–¥–∞–∂</option>
                                <option value="good_demand">–•–æ—Ä–æ—à–∏–π —Å–ø—Ä–æ—Å</option>
                                <option value="low_demand">–ù–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å</option>
                                <option value="no_demand">–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø—Ä–æ—Å–∞</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–ó–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å—è—Ü</label>
                            <input type="number" class="form-control" id="editRequests">
                        </div>
                        <div class="col-12">
                            <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                            <input type="text" class="form-control" id="editSource">
                        </div>
                        <div class="col-12">
                            <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="editNotes" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" onclick="deleteStat()">–£–¥–∞–ª–∏—Ç—å</button>
                <button type="button" class="btn btn-primary" onclick="saveStat()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentStats = [];
let currentPage = 1; // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

document.addEventListener('DOMContentLoaded', function() {
    loadStatistics(currentPage); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    setupUploadForms();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –Ω–æ–º–µ—Ä–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function loadStatistics(page = 1) {
    currentPage = page; // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    const tbody = document.getElementById('statsTableBody');
    tbody.innerHTML = '<tr><td colspan="10" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';

    const dataType = document.getElementById('dataTypeFilter').value;
    const volumeGroup = document.getElementById('volumeGroupFilter').value;
    const search = document.getElementById('searchFilter').value;

    const params = new URLSearchParams({
        page: currentPage,
        per_page: 50 // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º
    });

    if (dataType !== 'all') params.append('data_type', dataType);
    if (volumeGroup !== 'all') params.append('volume_group', volumeGroup);
    if (search) params.append('search', search);

    fetch(`/api/sales_statistics?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            currentStats = data.stats; // –¢–µ–ø–µ—Ä—å –¥–∞–Ω–Ω—ã–µ –≤ data.stats
            displayStats(data.stats);
            updatePaginationUI(data.total_pages, data.current_page, data.total_count); // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            tbody.innerHTML = '<tr><td colspan="10" class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
        });
}
// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
function displayStats(stats) {
    const tbody = document.getElementById('statsTableBody');
    if (stats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</td></tr>';
        return;
    }
    
tbody.innerHTML = stats.map(stat => {
    const typeBadge = getDataTypeBadge(stat.data_type);
    const groupBadge = getVolumeGroupBadge(stat.volume_group);
    
    return `
        <tr>
            <td>${typeBadge}</td>
            <td>${stat.brand_name}</td>
            <td>${stat.main_article}</td>
            <td>${stat.name_ru || '-'}</td>  <!-- –ù–û–í–û–ï –ü–û–õ–ï -->
            <td>${stat.period}</td>
            <td>${stat.quantity ? `<span class="fw-bold">${stat.quantity} —à—Ç</span>` : '-'}</td>
            <td>${groupBadge}</td>
            <td>${stat.requests_per_month || '-'}</td>
            <td>${stat.source_name || '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" 
                        onclick="editStat(${stat.id})">
                    <i class="bi bi-pencil"></i>
                </button>
            </td>
        </tr>
    `;
}).join('');
}

    // üî• –í–û–¢ –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø –§–£–ù–ö–¶–ò–ò üî•
    function updatePaginationUI(totalPages, currentPage, totalCount) {
        const paginationContainer = document.getElementById('paginationContainer');
        const statsCount = document.getElementById('statsCount');

        statsCount.textContent = `${totalCount} –∑–∞–ø–∏—Å–µ–π`;
        paginationContainer.innerHTML = '';

        if (totalPages <= 1) {
            return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é, –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –º–µ–Ω—å—à–µ –∏–ª–∏ –æ–¥–Ω–∞
        }

        let paginationHTML = '<ul class="pagination">';

        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); loadStatistics(${currentPage - 1})">–ù–∞–∑–∞–¥</a>
            </li>`;

        // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å—Ç—Ä–∞–Ω–∏—Ü (—á—Ç–æ–±—ã –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—å –≤—Å–µ 1000 —Å—Ç—Ä–∞–Ω–∏—Ü)
        const pagesToShow = [];
        const range = 2; // –°–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–æ –∏ –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–π

        pagesToShow.push(1); // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

        if (currentPage > range + 2) {
            pagesToShow.push('...'); // –ú–Ω–æ–≥–æ—Ç–æ—á–∏–µ –≤ –Ω–∞—á–∞–ª–µ
        }

        for (let i = Math.max(2, currentPage - range); i <= Math.min(totalPages - 1, currentPage + range); i++) {
            if (!pagesToShow.includes(i)) {
                pagesToShow.push(i);
            }
        }

        if (currentPage < totalPages - range - 1) {
            pagesToShow.push('...'); // –ú–Ω–æ–≥–æ—Ç–æ—á–∏–µ –≤ –∫–æ–Ω—Ü–µ
        }

        if (totalPages > 1 && !pagesToShow.includes(totalPages)) {
             pagesToShow.push(totalPages); // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –∫–Ω–æ–ø–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü
        pagesToShow.forEach(pageNum => {
            if (pageNum === '...') {
                 paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            } else {
                 paginationHTML += `
                    <li class="page-item ${pageNum === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadStatistics(${pageNum})">${pageNum}</a>
                    </li>`;
            }
        });


        // –ö–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ"
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); loadStatistics(${currentPage + 1})">–î–∞–ª–µ–µ</a>
            </li>`;

        paginationHTML += '</ul>';
        paginationContainer.innerHTML = paginationHTML;
    }




// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –±–µ–π–¥–∂–µ–π
function getDataTypeBadge(dataType) {
    const badges = {
        'own_sales': '<span class="badge bg-success">–ú–æ–∏ –ø—Ä–æ–¥–∞–∂–∏</span>',
        'competitor_sales': '<span class="badge bg-warning">–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã</span>',
        'analytics_center': '<span class="badge bg-info">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>'
    };
    return badges[dataType] || dataType;
}

function getVolumeGroupBadge(volumeGroup) {
    const badges = {
        'top_sales': '<span class="badge bg-danger">–¢–æ–ø –ø—Ä–æ–¥–∞–∂</span>',
        'good_demand': '<span class="badge bg-success">–•–æ—Ä–æ—à–∏–π —Å–ø—Ä–æ—Å</span>',
        'low_demand': '<span class="badge bg-warning">–ù–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å</span>',
        'no_demand': '<span class="badge bg-secondary">–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–ø—Ä–æ—Å–∞</span>'
    };
    return badges[volumeGroup] || '-';
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ—Ä–º –∑–∞–≥—Ä—É–∑–∫–∏
function setupUploadForms() {
    document.querySelectorAll('.upload-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = this.querySelector('input[type="file"]');
            const dataType = this.dataset.type;
            uploadStatistics(fileInput.files[0], dataType);
        });
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
function uploadStatistics(file, dataType) {
    if (!file) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('data_type', dataType);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const uploadBtn = event.submitter || event.target.querySelector('.upload-btn');
    const originalText = uploadBtn.innerHTML;
    uploadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
    uploadBtn.disabled = true;

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
    const validateBtn = event.target.querySelector('.validate-btn');
    if (validateBtn) {
        validateBtn.disabled = true;
    }

    fetch('/api/sales_statistics/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('uploadResult');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        uploadBtn.innerHTML = originalText;
        uploadBtn.disabled = false;
        if (validateBtn) validateBtn.disabled = false;

        if (data.success) {
            let message = `
                <div class="alert alert-success">
                    <strong>‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!</strong><br>
                    –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data.added}<br>
                    –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data.updated}<br>
                    –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${data.total}
            `;
            
            if (data.new_brands && data.new_brands.length > 0) {
                message += `<br><br><strong>‚ö†Ô∏è –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –±—Ä–µ–Ω–¥—ã:</strong><br>${data.new_brands.join(', ')}`;
                message += `<br><small class="text-muted">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–µ—Ç –ª–∏ –æ–ø–µ—á–∞—Ç–æ–∫ –≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö –±—Ä–µ–Ω–¥–æ–≤</small>`;
            }
            
            message += `</div>`;
            
            resultDiv.innerHTML = message;
            resultDiv.style.display = 'block';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —Ñ–∞–π–ª–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            document.querySelectorAll('input[type="file"]').forEach(input => input.value = '');
            loadStatistics();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!', 'success');
            
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${data.error}
                </div>
            `;
            resultDiv.style.display = 'block';
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        uploadBtn.innerHTML = originalText;
        uploadBtn.disabled = false;
        if (validateBtn) validateBtn.disabled = false;
        
        document.getElementById('uploadResult').innerHTML = `
            <div class="alert alert-danger">
                <strong>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞</strong>
            </div>
        `;
        document.getElementById('uploadResult').style.display = 'block';
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞', 'error');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function editStat(statId) {
    const stat = currentStats.find(s => s.id === statId);
    if (!stat) return;
    
    document.getElementById('editStatId').value = stat.id;
    document.getElementById('editDataType').value = stat.data_type;
    document.getElementById('editPeriod').value = stat.period;
    document.getElementById('editBrand').value = stat.brand_name;
    document.getElementById('editArticle').value = stat.main_article;
    document.getElementById('editQuantity').value = stat.quantity || '';
    document.getElementById('editVolumeGroup').value = stat.volume_group || '';
    document.getElementById('editRequests').value = stat.requests_per_month || '';
    document.getElementById('editSource').value = stat.source_name || '';
    document.getElementById('editNotes').value = stat.notes || '';
    
    new bootstrap.Modal(document.getElementById('editStatModal')).show();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function saveStat() {
    const statData = {
        data_type: document.getElementById('editDataType').value,
        period: document.getElementById('editPeriod').value,
        brand: document.getElementById('editBrand').value,
        main_article: document.getElementById('editArticle').value,
        quantity: document.getElementById('editQuantity').value || null,
        volume_group: document.getElementById('editVolumeGroup').value || null,
        requests_per_month: document.getElementById('editRequests').value || null,
        source_name: document.getElementById('editSource').value || '',
        notes: document.getElementById('editNotes').value || ''
    };

    const statId = document.getElementById('editStatId').value;

    fetch('/api/sales_statistics/' + statId, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(statData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editStatModal')).hide();
            loadStatistics();
            alert('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function deleteStat() {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏?')) return;
    
    const statId = document.getElementById('editStatId').value;

    fetch('/api/sales_statistics/' + statId, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editStatModal')).hide();
            loadStatistics();
            alert('–ó–∞–ø–∏—Å—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∞!');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
    });
}

    // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function clearFilters() {
        document.getElementById('dataTypeFilter').value = 'all';
        document.getElementById('volumeGroupFilter').value = 'all';
        document.getElementById('searchFilter').value = '';
        loadStatistics(1); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    }


// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–π–ª–∞
function validateFile(file, dataType) {
    if (!file) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
        return;
    }

    const formData = new FormData();
    formData.append('file', file);
    formData.append('data_type', dataType);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const validateBtn = event.target;
    const originalText = validateBtn.innerHTML;
    validateBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    validateBtn.disabled = true;

    fetch('/api/validate_upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        validateBtn.innerHTML = originalText;
        validateBtn.disabled = false;

        if (data.success) {
            showValidationResults(data.analysis, dataType);
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        validateBtn.innerHTML = originalText;
        validateBtn.disabled = false;
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ñ–∞–π–ª–∞');
    });
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
function showValidationResults(analysis, dataType) {
    const resultDiv = document.getElementById('uploadResult');
    
    let message = `
        <div class="alert alert-info">
            <h6><i class="bi bi-clipboard-check"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</h6>
            <p><strong>–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ:</strong> ${analysis.total_rows}</p>
            <p><strong>–°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–µ—Ç–∞–ª–µ–π –≤ –∫–∞—Ç–∞–ª–æ–≥–µ:</strong> ${analysis.existing_parts}</p>
    `;

    if (analysis.new_brands.length > 0) {
        message += `
            <div class="mt-3">
                <p class="text-warning mb-1"><strong>‚ö† –ù–æ–≤—ã–µ –±—Ä–µ–Ω–¥—ã:</strong> ${analysis.new_brands.length}</p>
                <ul class="small">
                    ${analysis.new_brands.map(brand => `<li>${brand}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    if (analysis.new_parts.length > 0) {
        message += `
            <div class="mt-3">
                <p class="text-warning mb-1"><strong>‚ö† –ù–æ–≤—ã–µ –¥–µ—Ç–∞–ª–∏ (–±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥):</strong> ${analysis.new_parts.length}</p>
                <ul class="small">
                    ${analysis.new_parts.map(part => `<li>${part}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    if (analysis.new_brands.length === 0 && analysis.new_parts.length === 0) {
        message += `
            <div class="mt-3">
                <p class="text-success mb-0"><strong>‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ!</strong> –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–∞–π–ª.</p>
            </div>
        `;
    } else {
        message += `
            <div class="mt-3">
                <p class="text-warning mb-0"><strong>‚ö† –í–Ω–∏–º–∞–Ω–∏–µ!</strong> –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –±—Ä–µ–Ω–¥—ã –∏ –¥–µ—Ç–∞–ª–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥.</p>
            </div>
        `;
    }

    message += `</div>`;
    
    resultDiv.innerHTML = message;
    resultDiv.style.display = 'block';
}

// –û–±–Ω–æ–≤–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Ñ–æ—Ä–º –∑–∞–≥—Ä—É–∑–∫–∏
function setupUploadForms() {
    document.querySelectorAll('.upload-form').forEach(form => {
        const fileInput = form.querySelector('.file-input');
        const validateBtn = form.querySelector('.validate-btn');
        const uploadBtn = form.querySelector('.upload-btn');
        const dataType = form.dataset.type;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏
        validateBtn.addEventListener('click', function(e) {
            e.preventDefault();
            validateFile(fileInput.files[0], dataType);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadStatistics(fileInput.files[0], dataType);
        });
    });
}


// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
document.getElementById('editPeriod').value = new Date().toISOString().split('T')[0];
</script>

<style>
.table td {
    vertical-align: middle;
}
.nav-tabs .nav-link {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
}
.badge {
    font-size: 0.75rem;
}
.validate-btn, .upload-btn {
    font-size: 0.875rem;
}
.alert ul {
    margin-bottom: 0;
    max-height: 200px;
    overflow-y: auto;
}
.small li {
    padding: 2px 0;
}
.position-fixed {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

</style>
{% endblock %}