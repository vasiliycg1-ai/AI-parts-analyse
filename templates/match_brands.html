<!-- templates/match_brands.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Сопоставление артикулов с брендами</h2>
    <p class="text-muted">Загрузите Excel-файл с артикулами. Программа найдет соответствующие бренды из каталога.</p>
    <div class="mb-3">
        <label for="fileInput" class="form-label">Выберите файл Excel (.xlsx, .xls)</label>
        <input type="file" class="form-control" id="fileInput" accept=".xlsx, .xls">
    </div>
    <button class="btn btn-primary" id="uploadBtn">Загрузить и обработать</button>

    <div class="status mt-3" id="status"></div>

    <!-- Таблица результатов -->
    <div class="result-table mt-4" id="resultTableContainer" style="display: none;">
        <h3 class="mb-3">Результаты:</h3>
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="resultsTable">
                <thead class="table-dark">
                    <tr id="resultsTableHeader"></tr>
                </thead>
                <tbody id="resultsTableBody"></tbody>
            </table>
        </div>
        <button class="btn btn-success mt-3" id="downloadBtn">Скачать результат (Excel)</button>
        <!-- <p class="text-info mt-2">Внимание: Результат пока сохраняется в формате JSON. Для Excel на бэкенде потребуется дополнительная реализация.</p> -->
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#uploadBtn').click(uploadAndProcess);
        $('#downloadBtn').click(downloadResults);

        let processedData = []; // Хранит обработанные данные

        function uploadAndProcess() {
            const fileInput = $('#fileInput')[0];
            const file = fileInput.files[0];
            if (!file) {
                alert('Пожалуйста, выберите файл.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            $('#status').html('<div class="alert alert-info">Обработка файла...</div>');
            $('#resultTableContainer').hide(); // Скрываем таблицу до получения результата

            $.ajax({
                url: '/api/match_brands',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        processedData = response.data; // Сохраняем данные
                        displayResults(response.data);
                        $('#status').html(`
                            <div class="alert alert-success">
                                Обработка завершена. Всего обработано: ${response.total_articles}, Не найдено: ${response.not_found_count}.
                            </div>
                        `);
                        $('#resultTableContainer').show(); // Показываем таблицу
                    } else {
                        $('#status').html(`<div class="alert alert-danger">Ошибка: ${response.error}</div>`);
                    }
                },
                error: function(xhr) {
                    const errorData = xhr.responseJSON;
                    const errorMsg = errorData && errorData.error ? errorData.error : 'Неизвестная ошибка';
                    $('#status').html(`<div class="alert alert-danger">Ошибка: ${errorMsg}</div>`);
                }
            });
        }

        function displayResults(data) {
            if (!data || data.length === 0) {
                $('#status').html('<div class="alert alert-warning">Нет данных для отображения.</div>');
                return;
            }

            const tableHeader = $('#resultsTableHeader');
            const tableBody = $('#resultsTableBody');
            tableHeader.empty();
            tableBody.empty();

            // Формируем заголовки таблицы на основе ключей первого объекта результата
            const headers = Object.keys(data[0]);
            headers.forEach(header => {
                tableHeader.append(`<th>${header}</th>`);
            });

            // Формируем строки таблицы
            data.forEach(row => {
                const tr = $('<tr>');
                headers.forEach(header => {
                    let cellValue = row[header];
                    // Подсвечиваем статус бренда
                    if (header === 'brand_matched') {
                        if (cellValue === 'НЕ НАЙДЕН') {
                            cellValue = `<span class="text-danger fw-bold">${cellValue}</span>`;
                        } else {
                            cellValue = `<span class="text-success">${cellValue}</span>`;
                        }
                    }
                    tr.append(`<td>${cellValue}</td>`);
                });
                tableBody.append(tr);
            });
        }

        // --- ИЗМЕНЕНАЯ ФУНКЦИЯ DOWNLOAD ---
        function downloadResults() {
            if (!processedData || processedData.length === 0) {
                alert('Нет данных для скачивания.');
                return;
            }

            // Отправляем собранные данные на сервер для генерации Excel
            const exportData = { data: processedData };

            $.ajax({
                url: '/api/match_brands/export',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(exportData),
                xhrFields: {
                    responseType: 'blob' // Важно для получения бинарного ответа
                },
                success: function(blob, status, xhr) {
                    // Создаем временный URL для blob
                    const blobUrl = window.URL.createObjectURL(blob);
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", blobUrl);

                    // Получаем имя файла из заголовка ответа, если сервер его возвращает
                    const disposition = xhr.getResponseHeader('Content-Disposition');
                    let filename = "matched_brands_results.xlsx"; // Имя по умолчанию
                    if (disposition && disposition.indexOf('attachment') !== -1) {
                        const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                        const matches = filenameRegex.exec(disposition);
                        if (matches != null && matches[1]) {
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }
                    downloadAnchorNode.setAttribute("download", filename);

                    document.body.appendChild(downloadAnchorNode); // required for firefox
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();

                    // Освобождаем временный URL
                    window.URL.revokeObjectURL(blobUrl);
                },
                error: function(xhr, status, error) {
                    console.error('Ошибка при скачивании Excel:', error);
                    alert('Ошибка при скачивании файла: ' + error);
                }
            });
        }
        // --- /ИЗМЕНЕНАЯ ФУНКЦИЯ DOWNLOAD ---
    });
</script>
{% endblock %}